name: Build & Release

on:
  push:
    branches: ["v2"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  check-tag:
    name: Version Check
    runs-on: ubuntu-latest
    outputs:
      created: ${{ steps.tagger.outputs.created }}
      version: ${{ steps.tagger.outputs.version }}
      previous_failed: ${{ steps.previous_run.outputs.previous_failed }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check previous workflow result
        id: previous_run
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              branch: context.ref.replace('refs/heads/', ''),
              status: 'completed',
              per_page: 5,
            });

            const previousRun = (data.workflow_runs || []).find(
              (run) => run.id !== context.runId
            );

            if (!previousRun) {
              core.info('No previous completed workflow runs found. Skipping check.');
              core.setOutput('previous_failed', 'false');
              return;
            }

            core.info(`Previous run: ${previousRun.html_url} -> ${previousRun.conclusion}`);

            if (previousRun.conclusion !== 'success') {
              core.setOutput('previous_failed', 'true');
              return;
            }

            core.setOutput('previous_failed', 'false');

      - name: Check Cargo.toml and Tag
        id: tagger
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.previous_run.outputs.previous_failed }}" = "true" ]; then
            echo "::notice::Previous build failed. Skipping tag and retrying build only."
            echo "created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          version=$(grep -m1 '^version\s*=' Cargo.toml | sed -E 's/version\s*=\s*"([^"]+)"/\1/')

          if [ -z "$version" ]; then
            echo "::error::Unable to determine version from Cargo.toml"
            exit 1
          fi

          tag="v${version}"
          echo "Current Cargo Version: $tag"

          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "::notice::Tag $tag already exists. Skipping build."
            echo "created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag "$tag"
          git push origin "$tag"

          echo "::notice::Created new tag: $tag"
          echo "created=true" >> $GITHUB_OUTPUT
          echo "version=$tag" >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.platform.os_name }}
    runs-on: ${{ matrix.platform.os }}
    needs: check-tag
    if: needs.check-tag.outputs.created == 'true' || needs.check-tag.outputs.previous_failed == 'true'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os_name: Linux
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bin: tidal-rs
            name: tidal-rs-linux-x86_64
          - os_name: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            bin: tidal-rs.exe
            name: tidal-rs-windows-x86_64.exe

    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies (Linux)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libmpv-dev

      - name: Install Dependencies (Windows only)
        if: matrix.platform.os == 'windows-latest'
        run: |
          curl -L -o mpv-dev.7z https://github.com/zhongfly/mpv-winbuild/releases/download/2026-01-08-85bf9f4/mpv-dev-x86_64-20260108-git-85bf9f4.7z
          7z x mpv-dev.7z -oC:\mpv-dev
          ren C:\mpv-dev\libmpv.dll.a C:\mpv-dev\mpv.lib
          echo "MPV_SOURCE=C:\mpv-dev" >> $env:GITHUB_ENV
          echo "C:\mpv-dev" >> $env:GITHUB_PATH

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust Cache
        uses: swatinem/rust-cache@v2

      - name: Build Release
        env:
          MPV_SOURCE: ${{ env.MPV_SOURCE || '' }}
          TIDAL_MASTER_DECRYPTION_KEY: ${{ secrets.TIDAL_MASTER_DECRYPTION_KEY }}
        run: cargo build --release --verbose --target ${{ matrix.platform.target }}

      - name: Optimize Binary (Linux)
        if: matrix.platform.os == 'ubuntu-latest'
        run: strip target/${{ matrix.platform.target }}/release/${{ matrix.platform.bin }}

      - name: Prepare Artifacts
        shell: bash
        run: |
          mkdir -p dist
          cp target/${{ matrix.platform.target }}/release/${{ matrix.platform.bin }} dist/${{ matrix.platform.name }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.name }}
          path: dist/${{ matrix.platform.name }}
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [check-tag, build]
    if: needs.check-tag.outputs.created == 'true'
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-tag.outputs.version }}
          name: Release ${{ needs.check-tag.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: artifacts/*
